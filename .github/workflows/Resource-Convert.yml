name: Resource Convert

on:
  issues:
    types: [opened]

permissions:
  contents: write
  issues: write

jobs:
  convert:
    if: contains(github.event.issue.title, '[Resource Pack]')
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: ğŸ“„ Issueã®å†…å®¹ã‚’è§£æ
        id: parse
        run: |
          ISSUE_BODY="${{ github.event.issue.body }}"
          DOWNLOAD_URL=$(echo "$ISSUE_BODY" | grep -o 'https\?://[^ ]*' | head -1)
          
          if [ -z "$DOWNLOAD_URL" ]; then
            echo "::error::ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰URLãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi
          
          echo "download_url=$DOWNLOAD_URL" >> $GITHUB_OUTPUT
          echo "issue_number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          
          echo "Found URL: $DOWNLOAD_URL"

      - name: ğŸ“¦ ãƒªã‚½ãƒ¼ã‚¹ãƒ‘ãƒƒã‚¯ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        run: |
          wget -O resource-pack.zip "${{ steps.parse.outputs.download_url }}"
          ls -la resource-pack.zip

      - name: ğŸ“¦ ãƒªã‚½ãƒ¼ã‚¹ãƒ‘ãƒƒã‚¯ã‚’å±•é–‹
        run: |
          echo "ğŸ“¦ ãƒªã‚½ãƒ¼ã‚¹ãƒ‘ãƒƒã‚¯ã‚’å±•é–‹ä¸­..."
          unzip -q resource-pack.zip -d resource-pack/
          ls -la resource-pack/

      - name: ğŸ”§ McEncryptorã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        run: |
          echo "ğŸ”§ McEncryptorã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ä¸­..."
          chmod +x MCEnc/McEncryptor.exe
          ls -la MCEnc/

      - name: âœ¨ ãƒªã‚½ãƒ¼ã‚¹ãƒ‘ãƒƒã‚¯ã‚’å¤‰æ›
        run: |
          echo "âœ¨ ãƒªã‚½ãƒ¼ã‚¹ãƒ‘ãƒƒã‚¯å¤‰æ›ã‚’é–‹å§‹..."
          cd resource-pack
          find . -name "*.json" | head -5

          # McEncryptorã§å¤‰æ›å®Ÿè¡Œ
          if [ -f "../MCEnc/McEncryptor.exe" ]; then
            echo "McEncryptorã§å¤‰æ›å®Ÿè¡Œä¸­..."
            mono ../MCEnc/McEncryptor.exe
          else
            echo "âŒ McEncryptor.exeãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi

          echo "âœ… å¤‰æ›å®Œäº†"

      - name: ğŸ“¦ å¤‰æ›æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–
        run: |
          echo "ğŸ“¦ å¤‰æ›æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ä¸­..."
          cd resource-pack
          zip -r ../converted-resource-pack.zip .
          cd ..
          ls -la converted-resource-pack.zip

      - name: ğŸ“¤ å¤‰æ›æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@v4
        with:
          name: converted-resource-pack
          path: converted-resource-pack.zip

      - name: ğŸ’¬ Issueã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿
        uses: actions/github-script@v7
        env:
          ISSUE_NUMBER: ${{ steps.parse.outputs.issue_number }}
        with:
          script: |
            const issueNumber = process.env.ISSUE_NUMBER;
            const runId = process.env.GITHUB_RUN_ID;
            const repoUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}`;

            const comment = [
              'âœ… **ãƒªã‚½ãƒ¼ã‚¹ãƒ‘ãƒƒã‚¯å¤‰æ›ãŒå®Œäº†ã—ã¾ã—ãŸï¼**',
              '',
              'ğŸ“¦ å¤‰æ›æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰',
              `${repoUrl}/actions/runs/${runId}`,
              '',
              'ğŸ‰ å¤‰æ›å‡¦ç†ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸã€‚ä¸Šè¨˜ã®ãƒªãƒ³ã‚¯ã‹ã‚‰Artifactsã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§å¤‰æ›æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚'
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt(issueNumber),
              body: comment
            });

      - name: ğŸ”’ Issueã‚’ã‚¯ãƒ­ãƒ¼ã‚º
        uses: actions/github-script@v7
        env:
          ISSUE_NUMBER: ${{ steps.parse.outputs.issue_number }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          script: |
            const issueNumber = process.env.ISSUE_NUMBER;
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt(issueNumber),
              state: 'closed'
            });
            console.log('âœ… Issue #' + issueNumber + ' ã‚’ã‚¯ãƒ­ãƒ¼ã‚ºã—ã¾ã—ãŸ')