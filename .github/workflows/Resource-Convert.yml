name: Resource Convert

on:
  issues:
    types: [labeled]

permissions:
  issues: write
  contents: read

jobs:
  convert-resource-pack:
    if: github.event.label.name == 'build'
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download attachment
        id: download
        uses: actions/github-script@v7
        with:
          script: |
            try {
              const fs = require('fs');
              const path = require('path');
              const { execSync } = require('child_process');
              
              const issueBody = context.payload.issue.body || '';
              const comments = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number
              });
              
              const textToSearch = [issueBody];
              for (const comment of comments.data) {
                textToSearch.push(comment.body);
              }
              
              let attachmentUrl = null;
              let fileName = null;
              
              for (const text of textToSearch) {
                const regex = /https:\/\/github\.com\/[^\/\s]+\/(?:files|user-attachments\/files)\/[^\/\s]+\/[^\/\s]+\.zip/gi;
                const matches = text.match(regex);
                
                if (matches && matches.length > 0) {
                  attachmentUrl = matches[0];
                  fileName = path.basename(attachmentUrl);
                  break;
                }
                
                const mdLinkRegex = /\[.*?\]\((https:\/\/github\.com\/[^\/\s]+\/(?:files|user-attachments\/files)\/[^\/\s]+\/[^\/\s]+\.zip)\)/gi;
                let mdMatch;
                
                while ((mdMatch = mdLinkRegex.exec(text)) !== null) {
                  attachmentUrl = mdMatch[1];
                  fileName = path.basename(attachmentUrl);
                  break;
                }
                
                if (attachmentUrl) break;
              }
              
              if (!attachmentUrl) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: 'ğŸš« **ã‚¨ãƒ©ãƒ¼**: ZIP ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã®ãƒªã‚½ãƒ¼ã‚¹ãƒ‘ãƒƒã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚\n\nIssueæœ¬æ–‡ã¾ãŸã¯ã‚³ãƒ¡ãƒ³ãƒˆã«ZIPãƒ•ã‚¡ã‚¤ãƒ«ã®URLã‚’è¨˜è¼‰ã—ã¦ãã ã•ã„ã€‚'
                });
                core.setFailed('ZIPãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
                return;
              }
              
              const downloadPath = path.join(process.env.GITHUB_WORKSPACE, fileName);
              execSync(`curl -L "${attachmentUrl}" -o "${downloadPath}"`);
              
              core.setOutput('file_path', downloadPath);
              core.setOutput('file_name', fileName);
              core.setOutput('download_success', 'true');
              return { file_path: downloadPath, file_name: fileName };
            } catch (error) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `ğŸš« **ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼**: ${error.message}`
              });
              throw error;
            }

      - name: Notify file detection
        if: steps.download.outputs.download_success == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fileName = '${{ steps.download.outputs.file_name }}';
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `ğŸ“¦ ZIP ãƒªã‚½ãƒ¼ã‚¹ãƒ‘ãƒƒã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ã€Œ**${fileName}**ã€ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚\n\nå¤‰æ›å‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™...ãŠå¾…ã¡ãã ã•ã„ã€‚`
            });

      - name: Convert resource pack
        id: convert
        if: steps.download.outputs.download_success == 'true'
        shell: cmd
        run: |
          @echo off
          
          :: å…¥åŠ›ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ã¨å‡ºåŠ›ãƒ‘ã‚¹ã‚’è¨­å®š
          set "filePath=${{ steps.download.outputs.file_path }}"
          set "outputPath=${{ runner.temp }}/converted_${{ steps.download.outputs.file_name }}"
          
          cd ${{ github.workspace }}
          
          :: McEncryptorã®ãƒ‘ã‚¹ã‚’è¨­å®š
          set "mcEncPath=${{ github.workspace }}\MCEnc\McEncryptor.exe"
          
          echo Files in MCEnc directory:
          dir /b "MCEnc"
          
          echo Executing McEncryptor: %mcEncPath%
          
          echo Current working directory:
          cd
          
          echo Attempting command execution...
          
          :: å…¥åŠ›ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
          if exist "%filePath%" (
            echo Input file exists: %filePath%
          ) else (
            echo Error: Input file %filePath% not found
            exit /b 1
          )
          
          :: ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸€æ™‚ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«è§£å‡
          set "extractDir=%TEMP%\mcencryptor_extract_%RANDOM%"
          echo Extracting ZIP file to: %extractDir%
          mkdir "%extractDir%" 2>nul
          
          :: è§£å‡å‡¦ç†ã‚’å®Ÿè¡Œ
          powershell -command "Expand-Archive -Path '%filePath%' -DestinationPath '%extractDir%' -Force"
          if %ERRORLEVEL% neq 0 (
            echo Error extracting ZIP file
            exit /b 1
          )
          
          echo ZIP file extracted successfully
          dir /s /b "%extractDir%"
          
          :: McEncryptorã«è§£å‡ã•ã‚ŒãŸãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ãƒ‘ã‚¹ã‚’æ¸¡ã™
          set "tempInputFile=%TEMP%\mcencryptor_input.txt"
          echo %extractDir%> "%tempInputFile%"
          echo Sending path to McEncryptor: %extractDir%
          type "%tempInputFile%" | "%mcEncPath%"
          
          echo McEncryptor execution completed. Searching for output files.
          
          :: å¤‰æ›å‡¦ç†ã®å®Œäº†ã‚’å¾…æ©Ÿ
          echo Waiting for conversion process to complete...
          timeout /t 15
          
          :: ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¢ã™ãŸã‚ã«åºƒç¯„å›²ã‚’æ¤œç´¢
          echo Searching for converted files in multiple locations...
          
          :: æ¤œç´¢å€™è£œã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’åˆ—æŒ™
          set "searchDirs=%extractDir% %extractDir%\.. %TEMP% ${{ github.workspace }}"
          
          :: æœ€è¿‘æ›´æ–°ã•ã‚ŒãŸZIPãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆå…ƒã®ãƒ•ã‚¡ã‚¤ãƒ«ä»¥å¤–ï¼‰ã‚’æ™‚é–“é †ã«è¡¨ç¤º
          echo Listing all recent ZIP files (sorted by time):
          for %%d in (%searchDirs%) do (
            echo Searching in: %%d
            dir /b /s /a-d /o-d "%%d\*.zip" 2>nul
          )
          
          :: æœ€åˆã«ä¸€è‡´ã™ã‚‹ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡¦ç†ï¼ˆå…ƒã®ãƒ•ã‚¡ã‚¤ãƒ«ä»¥å¤–ï¼‰
          set "found=false"
          for %%d in (%searchDirs%) do (
            if "%found%"=="false" (
              for /f "delims=" %%i in ('dir /b /s /a-d /o-d "%%d\*.zip" 2^>nul') do (
                if not "%%i"=="%filePath%" (
                  echo ZIP file found: %%i
                  set "convertedFile=%%i"
                  set "found=true"
                  goto :found_file
                )
              )
            )
          )
          
          :: ã‚‚ã—ä½•ã‚‚è¦‹ã¤ã‹ã‚‰ãªã‘ã‚Œã°ã€ç‰¹åˆ¥ãªæ¤œç´¢ã‚’è¡Œã†
          if "%found%"=="false" (
            echo No ZIP files found in primary search. Searching for any recent files...
            for /f "delims=" %%f in ('dir /b /s /a-d /o-d "%TEMP%\*.zip" "${{ github.workspace }}\*.zip" 2^>nul') do (
              if not "%%f"=="%filePath%" (
                if "!found!"=="false" (
                  echo Recent file found: %%f
                  set "convertedFile=%%f"
                  set "found=true"
                )
              )
            )
          )
          
          :found_file
          if "%found%"=="true" (
            echo Converted file found: %convertedFile%
            move "%convertedFile%" "%outputPath%"
            echo converted_file_path=%outputPath%>> %GITHUB_OUTPUT%
            for %%F in ("%convertedFile%") do echo converted_file_name=%%~nxF>> %GITHUB_OUTPUT%
            echo conversion_success=true>> %GITHUB_OUTPUT%
          ) else (
            echo Converted file search results:
            dir /b /s "${{ github.workspace }}\*.zip"
            echo conversion_success=false>> %GITHUB_OUTPUT%
            echo ::error::Converted file not found
            exit /b 1
          )

      - name: Notify conversion error
        if: failure() && steps.convert.conclusion == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `âŒ **å¤‰æ›ã‚¨ãƒ©ãƒ¼**: ãƒªã‚½ãƒ¼ã‚¹ãƒ‘ãƒƒã‚¯ã®å¤‰æ›ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\nãƒ•ã‚¡ã‚¤ãƒ«ãŒç ´æã—ã¦ã„ã‚‹ã‹ã€å¯¾å¿œã—ã¦ã„ãªã„å½¢å¼ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚`
            });

      - name: Upload converted file
        if: steps.convert.outputs.conversion_success == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: converted-resource-pack
          path: ${{ steps.convert.outputs.converted_file_path }}
          retention-days: 7

      - name: Create download link
        id: download_link
        if: steps.convert.outputs.conversion_success == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const downloadUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            core.setOutput('url', downloadUrl);
            return { url: downloadUrl };

      - name: Complete and close issue
        if: steps.convert.outputs.conversion_success == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const downloadUrl = '${{ steps.download_link.outputs.url }}';
            const fileName = '${{ steps.convert.outputs.converted_file_name }}';
            const originalFileName = '${{ steps.download.outputs.file_name }}';
            
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['converted']
            });
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `âœ… **ãƒªã‚½ãƒ¼ã‚¹ãƒ‘ãƒƒã‚¯ã®å¤‰æ›ãŒå®Œäº†ã—ã¾ã—ãŸï¼**\n\nğŸ“„ å…ƒã®ãƒ•ã‚¡ã‚¤ãƒ«: **${originalFileName}**\nğŸ“¦ å¤‰æ›ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«: **${fileName}**\n\n[ğŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯](${downloadUrl})\n\n*ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯7æ—¥é–“ä¿å­˜ã•ã‚Œã¾ã™*\n\nâœ¨ ã“ã®Issueã‚’è‡ªå‹•çš„ã«ã‚¯ãƒ­ãƒ¼ã‚ºã—ã¾ã™ã€‚`
            });
            
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              state: 'closed'
            });

      - name: Handle general failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `ğŸš« **ä¸€èˆ¬ã‚¨ãƒ©ãƒ¼**: äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n\nè©³ç´°: https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`
            });
