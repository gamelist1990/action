name: Resource Pack Converter

on:
  issues:
    types: [labeled]

jobs:
  convert-resource-pack:
    # buildラベルが追加された場合のみ実行
    if: github.event.label.name == 'build'
    runs-on: windows-latest
    name: Minecraft Resource Pack Converter

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Get issue info
        id: issue
        uses: actions/github-script@v6
        with:
          script: |
            const issueNumber = context.issue.number;
            const issue = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber
            });
            
            console.log('Issue title:', issue.data.title);
            console.log('Issue body:', issue.data.body);
            
            return {
              number: issueNumber,
              title: issue.data.title,
              body: issue.data.body
            };

      - name: Download attachment
        id: download
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            const { execSync } = require('child_process');
            
            // Issue本文からURLを抽出
            const issueBody = context.payload.issue.body || '';
            // コメントも確認するため、最新のコメントを取得
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            
            // Issue本文とすべてのコメントを検索対象にする
            const textToSearch = [issueBody];
            for (const comment of comments.data) {
              textToSearch.push(comment.body);
            }
            
            console.log('Searching in:', textToSearch);
            
            // URLを検索
            let attachmentUrl = null;
            let fileName = null;
            
            for (const text of textToSearch) {
              // ZIP形式のみを検出するように正規表現を修正
              const regex = /https:\/\/github\.com\/[^\/\s]+\/(?:files|user-attachments\/files)\/[^\/\s]+\/[^\/\s]+\.zip/gi;
              const matches = text.match(regex);
              
              if (matches && matches.length > 0) {
                attachmentUrl = matches[0];
                fileName = path.basename(attachmentUrl);
                break;
              }
              
              // Markdownリンク形式も検出（ZIP形式のみ）
              const mdLinkRegex = /\[.*?\]\((https:\/\/github\.com\/[^\/\s]+\/(?:files|user-attachments\/files)\/[^\/\s]+\/[^\/\s]+\.zip)\)/gi;
              let mdMatch;
              
              while ((mdMatch = mdLinkRegex.exec(text)) !== null) {
                attachmentUrl = mdMatch[1];
                fileName = path.basename(attachmentUrl);
                break;
              }
              
              if (attachmentUrl) break;
            }
            
            if (!attachmentUrl) {
              core.setFailed('ZIPファイル形式のリソースパックが見つかりませんでした。Issue本文またはコメントにZIPファイルのURLを記載してください。');
              return;
            }
            
            console.log('Found attachment URL:', attachmentUrl);
            console.log('File name:', fileName);
            
            const downloadPath = path.join(process.env.GITHUB_WORKSPACE, fileName);
            
            // ファイルをダウンロード
            execSync(`curl -L "${attachmentUrl}" -o "${downloadPath}"`);
            
            console.log(`Downloaded file to: ${downloadPath}`);
            core.setOutput('file_path', downloadPath);
            core.setOutput('file_name', fileName);
            return { file_path: downloadPath, file_name: fileName };

      - name: Notify file detection
        uses: actions/github-script@v6
        with:
          script: |
            const issueNumber = context.issue.number;
            const fileName = '${{ steps.download.outputs.file_name }}';
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `🔍 ZIPリソースパックファイル「**${fileName}**」を検出しました\n\n変換処理を開始します...お待ちください。`
            });

      - name: Convert resource pack
        id: convert
        shell: powershell
        run: |
          $filePath = "${{ steps.download.outputs.file_path }}"
          $outputPath = "${{ runner.temp }}/converted_${{ steps.download.outputs.file_name }}"
          
          # McEncryptor.exeの実行
          cd ${{ github.workspace }}
          $process = Start-Process -FilePath "MCEnc/McEncryptor.exe" -NoNewWindow -PassThru
          Start-Sleep -Seconds 2
          
          # ファイルパスの入力
          Add-Type -AssemblyName System.Windows.Forms
          [System.Windows.Forms.SendKeys]::SendWait("$filePath{ENTER}")
          
          # プロセスが終了するまで待機
          $process.WaitForExit()
          
          # 変換されたファイルを探して移動
          $convertedFile = Get-ChildItem -Path (Split-Path -Parent $filePath) -Filter "*converted*" | Select-Object -First 1
          if ($convertedFile) {
            Move-Item -Path $convertedFile.FullName -Destination $outputPath
            Write-Output "::set-output name=converted_file_path::$outputPath"
            Write-Output "::set-output name=converted_file_name::$($convertedFile.Name)"
          } else {
            Write-Output "::error::Converted file not found"
            exit 1
          }

      - name: Upload converted file
        uses: actions/upload-artifact@v3
        with:
          name: converted-resource-pack
          path: ${{ steps.convert.outputs.converted_file_path }}
          retention-days: 7

      - name: Create download link
        id: download_link
        uses: actions/github-script@v6
        with:
          script: |
            const artifactName = 'converted-resource-pack';
            const runId = context.runId;
            const repoOwner = context.repo.owner;
            const repoName = context.repo.repo;
            
            const downloadUrl = `https://github.com/${repoOwner}/${repoName}/actions/runs/${runId}/artifacts/${artifactName}`;
            core.setOutput('url', downloadUrl);
            return { url: downloadUrl };

      - name: Add label to issue
        uses: actions/github-script@v6
        with:
          script: |
            const issueNumber = context.issue.number;
            
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              labels: ['converted']
            });

      - name: Notify on issue
        uses: actions/github-script@v6
        with:
          script: |
            const issueNumber = context.issue.number;
            const downloadUrl = '${{ steps.download_link.outputs.url }}';
            const fileName = '${{ steps.convert.outputs.converted_file_name }}';
            const originalFileName = '${{ steps.download.outputs.file_name }}';
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `✅ リソースパックの変換が完了しました！\n\n元のファイル: **${originalFileName}**\n変換されたファイル: **${fileName}**\n\n[⬇️ ダウンロードリンク](${downloadUrl})\n\n*このファイルは7日間保存されます*`
            });
