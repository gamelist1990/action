name: Resource Pack Converter

on:
  issues:
    types: [labeled]

jobs:
  convert-resource-pack:
    # buildãƒ©ãƒ™ãƒ«ãŒè¿½åŠ ã•ã‚ŒãŸå ´åˆã®ã¿å®Ÿè¡Œ
    if: github.event.label.name == 'build'
    runs-on: windows-latest
    name: Minecraft Resource Pack Converter

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Get issue info
        id: issue
        uses: actions/github-script@v6
        with:
          script: |
            const issueNumber = context.issue.number;
            const issue = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber
            });
            
            console.log('Issue title:', issue.data.title);
            console.log('Issue body:', issue.data.body);
            
            return {
              number: issueNumber,
              title: issue.data.title,
              body: issue.data.body
            };

      - name: Download attachment
        id: download
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            const { execSync } = require('child_process');
            
            // Issueã®ã‚³ãƒ¡ãƒ³ãƒˆã‹ã‚‰æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã®URLã‚’æŠ½å‡º
            const comment = context.payload.comment;
            
            // ãƒ‡ãƒãƒƒã‚°ç”¨ã«ã‚³ãƒ¡ãƒ³ãƒˆå†…å®¹ã‚’ãƒ­ã‚°ã«å‡ºåŠ›
            console.log('Comment body:', comment.body);
            
            // ã‚ˆã‚ŠæŸ”è»Ÿãªæ­£è¦è¡¨ç¾ãƒ‘ã‚¿ãƒ¼ãƒ³ - GitHubã®æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«URLã‚’å¹…åºƒãæ¤œå‡º
            const regex = /https:\/\/github\.com\/[^\/\s]+\/(?:files|user-attachments\/files)\/[^\/\s]+\/[^\/\s]+\.(zip|mcpack)/gi;
            const matches = comment.body.match(regex);
            
            console.log('Matches found:', matches);
            
            if (!matches || matches.length === 0) {
              // Markdownãƒªãƒ³ã‚¯å½¢å¼ã‚‚æ¤œå‡ºã—ã¦ã¿ã‚‹
              const mdLinkRegex = /\[.*?\]\((https:\/\/github\.com\/[^\/\s]+\/(?:files|user-attachments\/files)\/[^\/\s]+\/[^\/\s]+\.(zip|mcpack))\)/gi;
              const mdMatches = [];
              let mdMatch;
              
              while ((mdMatch = mdLinkRegex.exec(comment.body)) !== null) {
                mdMatches.push(mdMatch[1]); // URLã®éƒ¨åˆ†ã ã‘ã‚’å–å¾—
              }
              
              console.log('Markdown link matches found:', mdMatches);
              
              if (mdMatches.length > 0) {
                // Markdownãƒªãƒ³ã‚¯ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å–å¾—
                const attachmentUrl = mdMatches[0];
                const fileName = path.basename(attachmentUrl);
                const downloadPath = path.join(process.env.GITHUB_WORKSPACE, fileName);
                
                // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                execSync(`curl -L "${attachmentUrl}" -o "${downloadPath}"`);
                
                console.log(`Downloaded file from markdown link to: ${downloadPath}`);
                core.setOutput('file_path', downloadPath);
                core.setOutput('file_name', fileName);
                return { file_path: downloadPath, file_name: fileName };
              }
              
              core.setFailed('No resource pack file found in the comment');
              return;
            }
            
            const attachmentUrl = matches[0];
            const fileName = path.basename(attachmentUrl);
            const downloadPath = path.join(process.env.GITHUB_WORKSPACE, fileName);
            
            // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            execSync(`curl -L "${attachmentUrl}" -o "${downloadPath}"`);
            
            console.log(`Downloaded file to: ${downloadPath}`);
            core.setOutput('file_path', downloadPath);
            core.setOutput('file_name', fileName);
            return { file_path: downloadPath, file_name: fileName };

      - name: Notify file detection
        uses: actions/github-script@v6
        with:
          script: |
            const issueNumber = context.issue.number;
            const fileName = '${{ steps.download.outputs.file_name }}';
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `ğŸ” ãƒªã‚½ãƒ¼ã‚¹ãƒ‘ãƒƒã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ã€Œ**${fileName}**ã€ã‚’æ¤œå‡ºã—ã¾ã—ãŸ\n\nå¤‰æ›å‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™...ãŠå¾…ã¡ãã ã•ã„ã€‚`
            });

      - name: Convert resource pack
        id: convert
        shell: powershell
        run: |
          $filePath = "${{ steps.download.outputs.file_path }}"
          $outputPath = "${{ runner.temp }}/converted_${{ steps.download.outputs.file_name }}"
          
          # McEncryptor.exeã®å®Ÿè¡Œ
          cd ${{ github.workspace }}
          $process = Start-Process -FilePath "MCEnc/McEncryptor.exe" -NoNewWindow -PassThru
          Start-Sleep -Seconds 2
          
          # ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã®å…¥åŠ›
          Add-Type -AssemblyName System.Windows.Forms
          [System.Windows.Forms.SendKeys]::SendWait("$filePath{ENTER}")
          
          # ãƒ—ãƒ­ã‚»ã‚¹ãŒçµ‚äº†ã™ã‚‹ã¾ã§å¾…æ©Ÿ
          $process.WaitForExit()
          
          # å¤‰æ›ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¢ã—ã¦ç§»å‹•
          $convertedFile = Get-ChildItem -Path (Split-Path -Parent $filePath) -Filter "*converted*" | Select-Object -First 1
          if ($convertedFile) {
            Move-Item -Path $convertedFile.FullName -Destination $outputPath
            Write-Output "::set-output name=converted_file_path::$outputPath"
            Write-Output "::set-output name=converted_file_name::$($convertedFile.Name)"
          } else {
            Write-Output "::error::Converted file not found"
            exit 1
          }

      - name: Upload converted file
        uses: actions/upload-artifact@v3
        with:
          name: converted-resource-pack
          path: ${{ steps.convert.outputs.converted_file_path }}
          retention-days: 7

      - name: Create download link
        id: download_link
        uses: actions/github-script@v6
        with:
          script: |
            const artifactName = 'converted-resource-pack';
            const runId = context.runId;
            const repoOwner = context.repo.owner;
            const repoName = context.repo.repo;
            
            const downloadUrl = `https://github.com/${repoOwner}/${repoName}/actions/runs/${runId}/artifacts/${artifactName}`;
            core.setOutput('url', downloadUrl);
            return { url: downloadUrl };

      - name: Add label to issue
        uses: actions/github-script@v6
        with:
          script: |
            const issueNumber = context.issue.number;
            
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              labels: ['converted']
            });

      - name: Notify on issue
        uses: actions/github-script@v6
        with:
          script: |
            const issueNumber = context.issue.number;
            const downloadUrl = '${{ steps.download_link.outputs.url }}';
            const fileName = '${{ steps.convert.outputs.converted_file_name }}';
            const originalFileName = '${{ steps.download.outputs.file_name }}';
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `âœ… ãƒªã‚½ãƒ¼ã‚¹ãƒ‘ãƒƒã‚¯ã®å¤‰æ›ãŒå®Œäº†ã—ã¾ã—ãŸï¼\n\nå…ƒã®ãƒ•ã‚¡ã‚¤ãƒ«: **${originalFileName}**\nå¤‰æ›ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«: **${fileName}**\n\n[â¬‡ï¸ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯](${downloadUrl})\n\n*ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯7æ—¥é–“ä¿å­˜ã•ã‚Œã¾ã™*`
            });
